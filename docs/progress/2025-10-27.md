# 2025-10-27 開発メモ

## 実装済みハイライト
- **プレビュー生成連続リクエストの収束**: `src/renderer/App.tsx` にキュー制御・プロジェクトハッシュを導入し、復旧直後でも `/preview/generate` が 1 回のみ実行されるようにしました。コンソールログで `request:start → success → complete (hasPending:false)` を確認済み。
- **プレビュー応答タイムアウトの緩和**: Electron メインプロセス側に `fetchWithTimeout` を追加し、既定で 60 秒まで応答を待てるようにしました。ビルド済み (`npm run build` / `npm test` 成功)。
- **復旧スロット整備**: `backend/storage/electron-preview.nveproj` のノード/エッジ定義をスキーマ準拠に修正。（`displayName` を空文字、`cachePolicy` を `"auto"`、エッジの `disabled` を `false` に統一。）復旧後の検証エラーが解消されたことを確認。
- **デバッグ用ログ埋め込み**: プレビュー処理に `console.debug('[preview] request:*')` を追加し、原因追跡しやすくした。

## 動作確認メモ
- `npm run dev` → 復旧モーダルで「復旧する」を選択。プレビューが 1 回だけ生成される（ログに連続リクエストが出ない）ことを確認。
- プレビュー再生成時も `hasPending:false` が維持され、FastAPI 側のログが暴走しない。
- `/preview/generate` が失敗した場合は `ProjectValidationError` が表示されるので、スキーマ違反フィールドを再確認する（例: `edges[*].disabled`）。

## 今後の TODO
1. プレビュー結果のトリガ（ノード変更・自動保存など）を洗い出し、必要なタイミングで `schedulePreview` を呼んでいるか確認。
2. `hashProject` の比較対象に必要な情報（具体的なノードパラメータなど）を追加するか検討。現状はノード/エッジ数と FPS/アセット ID に限定。
3. 長時間のプレビュー生成で依然タイムアウトが出る場合は、`DEFAULT_PREVIEW_FETCH_TIMEOUT_MS` を調整するか、バックエンド画像生成の軽量化を検討。

## 参考コマンド
```bash
npm run build
npm test
npm run dev
```
